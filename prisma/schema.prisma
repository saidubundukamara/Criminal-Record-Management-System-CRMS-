// CRMS - Criminal Record Management System
// Prisma Schema - Pan-African Digital Public Good

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== AUTHENTICATION & AUTHORIZATION ====================

model Officer {
  id              String    @id @default(uuid())
  badge           String    @unique
  name            String
  email           String?   @unique
  phone           String?
  pinHash         String    // Argon2id hash
  roleId          String
  role            Role      @relation(fields: [roleId], references: [id])
  stationId       String
  station         Station   @relation(fields: [stationId], references: [id])
  active          Boolean   @default(true)
  lastLogin       DateTime?
  pinChangedAt    DateTime  @default(now())
  failedAttempts  Int       @default(0)
  lockedUntil     DateTime?
  mfaEnabled      Boolean   @default(false)
  mfaSecret       String?   // TOTP secret (encrypted)
  mfaBackupCodes  String[]  // Encrypted backup codes

  // USSD Authentication (Phase 7)
  ussdPhoneNumber    String?   @unique
  ussdQuickPinHash   String?   // Argon2id hash of 4-digit Quick PIN
  ussdRegisteredAt   DateTime?
  ussdLastUsed       DateTime?
  ussdEnabled        Boolean   @default(false) // Admin must enable
  ussdDailyLimit     Int       @default(50)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  cases             Case[]
  auditLogs         AuditLog[]
  backgroundChecks  BackgroundCheck[]
  evidenceCollected Evidence[]      @relation("EvidenceCollectedBy")
  evidenceSealed    Evidence[]      @relation("EvidenceSealedBy")
  amberAlerts       AmberAlert[]
  wantedPersons     WantedPerson[]
  personsCreated    Person[]        @relation("PersonCreatedBy")
  personsUpdated    Person[]        @relation("PersonUpdatedBy")
  sessions          Session[]
  ussdQueries       USSDQueryLog[]

  @@index([badge])
  @@index([stationId])
  @@index([roleId])
  @@index([ussdPhoneNumber])
  @@map("officers")
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  officerId    String
  officer      Officer  @relation(fields: [officerId], references: [id], onDelete: Cascade)
  deviceInfo   Json?    // Browser, OS, IP
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  @@index([sessionToken])
  @@index([officerId])
  @@map("sessions")
}

model Role {
  id          String       @id @default(uuid())
  name        String       @unique
  description String?
  level       Int          @unique // 1=SuperAdmin, 2=Admin, 3=StationCommander, 4=Officer, 5=Clerk, 6=Viewer
  permissions Permission[]
  officers    Officer[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([name])
  @@index([level])
  @@map("roles")
}

model Permission {
  id       String   @id @default(uuid())
  resource String   // "cases", "persons", "evidence", "officers", "stations", "alerts", "bgcheck", "reports"
  action   String   // "create", "read", "update", "delete", "export"
  scope    String   // "own", "station", "region", "national"
  roles    Role[]

  @@unique([resource, action, scope])
  @@index([resource])
  @@map("permissions")
}

// ==================== CORE ENTITIES ====================

model Station {
  id          String    @id @default(uuid())
  name        String
  code        String    @unique  // Country-specific format (e.g., "HQ-001", "GPS-001")
  location    String
  district    String?
  region      String?
  countryCode String    @default("SLE") // ISO 3166-1 alpha-3
  phone       String?
  email       String?
  latitude    Float?
  longitude   Float?
  active      Boolean   @default(true)
  officers    Officer[]
  cases       Case[]
  persons     Person[]
  evidence    Evidence[]
  vehicles    Vehicle[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([code])
  @@index([region])
  @@index([countryCode])
  @@map("stations")
}

model Person {
  id              String        @id @default(uuid())
  nationalId      String?       @unique  // NIN, Ghana Card, Huduma Namba, etc.
  idType          String?                // "NIN", "GHANA_CARD", "HUDUMA_NAMBA", "SA_ID", "PASSPORT"
  countryCode     String        @default("SLE") // ISO 3166-1 alpha-3
  // Name fields (split for better flexibility and matching domain entity)
  firstName       String
  lastName        String
  middleName      String?
  fullName        String?       // Optional computed/cached field for backward compatibility
  aliases         String[]      @default([])
  dob             DateTime?
  gender          String?
  nationality     String        @default("SLE") // ISO 3166-1 alpha-3
  placeOfBirth    String?
  occupation      String?
  maritalStatus   String?
  educationLevel  String?
  tribe           String?       // Relevant in many African contexts
  religion        String?
  languagesSpoken String[]      @default([])
  physicalDescription String?   @db.Text
  addressEncrypted String?      // AES-256 encrypted
  phoneEncrypted  String?       // AES-256 encrypted
  emailEncrypted  String?       // AES-256 encrypted
  photoUrl        String?
  fingerprintHash String?       // SHA-256 hash
  biometricHash   String?
  criminalHistory String?       @db.Text
  notes           String?       @db.Text
  // Status tracking fields
  isWanted            Boolean   @default(false)
  wantedSince         DateTime?
  isDeceasedOrMissing Boolean   @default(false)
  riskLevel           String?   // "low", "medium", "high"
  stationId       String?
  station         Station?      @relation(fields: [stationId], references: [id])
  createdById     String
  createdBy       Officer       @relation("PersonCreatedBy", fields: [createdById], references: [id])
  updatedById     String?
  updatedBy       Officer?      @relation("PersonUpdatedBy", fields: [updatedById], references: [id])
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  cases           CasePerson[]
  wantedPerson    WantedPerson?

  @@index([nationalId])
  @@index([firstName, lastName])
  @@index([countryCode])
  @@index([createdById])
  @@index([updatedById])
  @@index([stationId])
  @@index([isWanted])
  @@index([riskLevel])
  @@map("persons")
}

model Case {
  id            String       @id @default(uuid())
  caseNumber    String       @unique  // Format: {StationCode}-{Year}-{SequentialNumber}
  title         String
  description   String?      @db.Text
  category      String       // "theft", "assault", "fraud", "murder", "robbery", "kidnapping", etc.
  severity      String       // "minor", "major", "critical"
  status        String       @default("open") // "open", "investigating", "charged", "court", "closed"
  incidentDate  DateTime
  reportedDate  DateTime     @default(now())
  location      String?
  stationId     String
  station       Station      @relation(fields: [stationId], references: [id])
  officerId     String       // Investigating officer
  officer       Officer      @relation(fields: [officerId], references: [id])
  persons       CasePerson[]
  evidence      Evidence[]
  notes         CaseNote[]
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([caseNumber])
  @@index([stationId])
  @@index([officerId])
  @@index([status])
  @@index([category])
  @@index([incidentDate])
  @@map("cases")
}

model CasePerson {
  id        String   @id @default(uuid())
  caseId    String
  case      Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)
  personId  String
  person    Person   @relation(fields: [personId], references: [id])
  role      String   // "suspect", "victim", "witness", "informant"
  statement String?  @db.Text
  createdAt DateTime @default(now())

  @@unique([caseId, personId, role])
  @@index([caseId])
  @@index([personId])
  @@index([role])
  @@map("case_persons")
}

model CaseNote {
  id        String   @id @default(uuid())
  caseId    String
  case      Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)
  content   String   @db.Text
  createdAt DateTime @default(now())

  @@index([caseId])
  @@map("case_notes")
}

model Evidence {
  id              String   @id @default(uuid())
  caseId          String
  case            Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)
  type            String   // "physical", "document", "photo", "video", "audio", "digital", "biological", "other"
  description     String?  @db.Text
  qrCode          String   @unique
  status          String   @default("collected") // "collected", "stored", "analyzed", "court", "returned", "destroyed"
  collectedLocation String // Physical location where evidence was collected
  collectedDate   DateTime
  collectedById   String
  collectedBy     Officer  @relation("EvidenceCollectedBy", fields: [collectedById], references: [id])
  storageUrl      String?  // S3 URL
  storageLocation String?  // Physical storage location
  fileKey         String?  // S3 key for file operations
  fileHash        String?  // SHA-256 for integrity
  fileName        String?
  fileSize        Int?
  mimeType        String?
  chainOfCustody  Json     // Array of custody events
  tags            String[] @default([])
  notes           String?  @db.Text
  isSealed        Boolean  @default(false)
  sealedAt        DateTime?
  sealedById      String?
  sealedBy        Officer? @relation("EvidenceSealedBy", fields: [sealedById], references: [id])
  stationId       String
  station         Station  @relation(fields: [stationId], references: [id])
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([caseId])
  @@index([qrCode])
  @@index([collectedById])
  @@index([stationId])
  @@index([status])
  @@map("evidence")
}

// ==================== ALERTS ====================

model AmberAlert {
  id               String    @id @default(uuid())
  personName       String
  age              Int?
  gender           String?
  description      String    @db.Text
  photoUrl         String?
  lastSeenLocation String?
  lastSeenDate     DateTime?
  contactPhone     String
  status           String    @default("active") // "active", "found", "expired"
  publishedAt      DateTime?
  expiresAt        DateTime?
  createdById      String
  createdBy        Officer   @relation(fields: [createdById], references: [id])
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([status])
  @@index([createdById])
  @@map("amber_alerts")
}

model WantedPerson {
  id          String   @id @default(uuid())
  personId    String?  @unique
  person      Person?  @relation(fields: [personId], references: [id])
  name        String
  aliases     String[]
  charges     String[]
  photoUrl    String?
  description String?  @db.Text
  reward      Decimal? @db.Decimal(10, 2)
  dangerLevel       String    @default("medium") // "low", "medium", "high", "extreme"
  status            String    @default("active") // "active", "captured", "expired"
  warrantNumber     String?   @unique
  lastSeenLocation  String?
  lastSeenDate      DateTime?
  regionalAlert     Boolean   @default(false)
  priority          Int       @default(50) // 0-100, calculated based on danger level and other factors
  publishedAt       DateTime?
  capturedAt        DateTime?
  capturedLocation  String?
  createdById       String
  createdBy   Officer  @relation(fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([status])
  @@index([personId])
  @@index([createdById])
  @@map("wanted_persons")
}

// ==================== BACKGROUND CHECKS ====================

model BackgroundCheck {
  id            String    @id @default(uuid())
  nin           String
  requestedById String?
  requestedBy   Officer?  @relation(fields: [requestedById], references: [id])
  requestType   String    // "officer", "citizen", "employer", "visa"
  result        Json      // Full or redacted results
  status        String    @default("pending") // "pending", "completed", "failed"
  issuedAt      DateTime?
  expiresAt     DateTime?
  certificateUrl String?
  phoneNumber   String?   // For citizen requests via USSD
  ipAddress     String?
  createdAt     DateTime  @default(now())

  @@index([nin])
  @@index([requestedById])
  @@index([phoneNumber])
  @@index([createdAt])
  @@map("background_checks")
}

// ==================== AUDIT & SYNC ====================

model AuditLog {
  id         String   @id @default(uuid())
  entityType String
  entityId   String?
  officerId  String?
  officer    Officer? @relation(fields: [officerId], references: [id])
  action     String   // "create", "read", "update", "delete", "login", "logout", "export"
  details    Json
  ipAddress  String?
  userAgent  String?
  stationId  String?
  success    Boolean  @default(true)
  createdAt  DateTime @default(now())

  @@index([entityType, entityId])
  @@index([officerId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

model SyncQueue {
  id         String    @id @default(uuid())
  entityType String
  entityId   String
  operation  String    // "create", "update", "delete"
  payload    Json
  status     String    @default("pending") // "pending", "processing", "completed", "failed"
  attempts   Int       @default(0)
  error      String?
  createdAt  DateTime  @default(now())
  syncedAt   DateTime?

  @@index([status])
  @@index([createdAt])
  @@map("sync_queue")
}

// ==================== PHASE 7: USSD & VEHICLE MANAGEMENT ====================

model Vehicle {
  id                String    @id @default(uuid())
  licensePlate      String    @unique
  ownerNIN          String?   // Links to Person.nationalId
  ownerName         String?
  vehicleType       String    // "car", "truck", "motorcycle", "bus", etc.
  make              String?
  model             String?
  color             String?
  year              Int?
  status            String    @default("active") // "active", "stolen", "impounded"
  stolenDate        DateTime?
  stolenReportedBy  String?   // Officer ID
  recoveredDate     DateTime?
  notes             String?   @db.Text
  stationId         String    // Where registered/reported
  station           Station   @relation(fields: [stationId], references: [id])
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([licensePlate])
  @@index([status])
  @@index([ownerNIN])
  @@index([stationId])
  @@map("vehicles")
}

model USSDQueryLog {
  id              String    @id @default(uuid())
  officerId       String
  officer         Officer   @relation(fields: [officerId], references: [id])
  phoneNumber     String
  queryType       String    // "wanted", "missing", "background", "vehicle", "stats"
  searchTerm      String    // NIN or license plate searched
  resultSummary   String?   // Basic result (no PII)
  success         Boolean   @default(true)
  errorMessage    String?
  timestamp       DateTime  @default(now())
  sessionId       String?   // USSD session ID from Africa's Talking

  @@index([officerId, timestamp])
  @@index([phoneNumber, timestamp])
  @@index([queryType])
  @@index([timestamp])
  @@map("ussd_query_logs")
}
